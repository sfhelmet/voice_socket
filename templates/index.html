<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 16px;
            cursor: pointer;
        }
        #status {
            margin: 20px 0;
            font-weight: bold;
        }
        .recording {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Voice Chat</h1>
    <div id="status">Ready to chat</div>
    <div class="controls">
        <button id="recordButton">Start Chat</button>
        <button id="stopButton" disabled>Stop Chat</button>
    </div>

    <script>
        const socket = io();
        const recordButton = document.getElementById('recordButton');
        const stopButton = document.getElementById('stopButton');
        const statusElement = document.getElementById('status');

        let mediaRecorder;
        let audioContext;
        let sourceNode;
        let processorNode;
        let isRecording = false;

        // Initialize audio recording
        async function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Create audio processing nodes
                sourceNode = audioContext.createMediaStreamSource(stream);
                processorNode = audioContext.createScriptProcessor(4096, 1, 1);
                
                // Set up audio processing
                processorNode.onaudioprocess = (e) => {
                    if (!isRecording) return;
                    
                    const inputData = e.inputBuffer.getChannelData(0);
                    const audioData = new Float32Array(inputData);
                    
                    // Convert Float32Array to base64
                    const audioBuffer = audioData.buffer;
                    const base64Audio = btoa(String.fromCharCode(...new Uint8Array(audioBuffer)));
                    
                    // Send audio data
                    socket.emit('voice_data', { audio: base64Audio });
                };

                // Connect nodes
                sourceNode.connect(processorNode);
                processorNode.connect(audioContext.destination);

                recordButton.disabled = false;
                statusElement.textContent = "Ready to chat";
            } catch (err) {
                console.error("Error accessing microphone:", err);
                statusElement.textContent = "Error: " + err.message;
            }
        }

        // Start recording
        recordButton.onclick = () => {
            if (isRecording) return;
            
            isRecording = true;
            recordButton.disabled = true;
            stopButton.disabled = false;
            statusElement.textContent = "Chatting...";
            statusElement.classList.add("recording");
        };

        // Stop recording
        stopButton.onclick = () => {
            if (!isRecording) return;
            
            isRecording = false;
            recordButton.disabled = false;
            stopButton.disabled = true;
            statusElement.textContent = "Ready to chat";
            statusElement.classList.remove("recording");
        };

        // Play received audio
        socket.on('voice_data', data => {
            if (!isRecording) return; // Only play if we're in chat mode
            
            const audioData = atob(data.audio);
            const arrayBuffer = new ArrayBuffer(audioData.length);
            const uint8Array = new Uint8Array(arrayBuffer);
            
            for (let i = 0; i < audioData.length; i++) {
                uint8Array[i] = audioData.charCodeAt(i);
            }
            
            const audioBuffer = audioContext.createBuffer(1, 4096, audioContext.sampleRate);
            const channelData = audioBuffer.getChannelData(0);
            
            for (let i = 0; i < 4096; i++) {
                channelData[i] = new Float32Array(arrayBuffer)[i];
            }
            
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.start();
        });

        // Initialize on page load
        window.onload = initAudio;
    </script>
</body>
</html>